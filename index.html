<!DOCTYPE html>
<html lang="el">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BudgetBuddy â€” ÎˆÎ¾Î¿Î´Î± Î£Ï€Î¹Ï„Î¹Î¿Ï</title>
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: linear-gradient(to bottom, #ffe6f1, #fff0f7);
    margin: 0;
    padding: 0;
    overflow-x: hidden;
  }

  .stars {
    position: fixed;
    top: 0; left: 0;
    width: 100%;
    height: 150px;
    overflow: hidden;
    z-index: 0;
  }

  .star {
    position: absolute;
    color: #fff;
    font-size: 18px;
    opacity: 0.8;
    animation: twinkle 5s infinite ease-in-out;
  }

  @keyframes twinkle {
    0%,100% { opacity: 0.3; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.3); }
  }

  .container {
    position: relative;
    z-index: 1;
    max-width: 900px;
    margin: 100px auto 40px;
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    padding: 25px 35px;
  }

  h1 {
    text-align: center;
    color: #e91e63;
    position: relative;
  }

  /* ÎÎ•ÎŸ: ÎšÎŸÎ¥ÎœÎ Î™ Î£Î¥ÎÎ”Î•Î£Î—Î£ ÎœÎ•Î£Î‘ Î£Î¤ÎŸÎ Î¤Î™Î¤Î›ÎŸ - Î ÎŸÎ›Î¥ Î•ÎœÎ¦Î‘ÎÎ•Î£! */
  .sync-header {
    position: relative;
    display: inline-block;
    padding-right: 50px; /* Î§ÏÏÎ¿Ï‚ Î³Î¹Î± Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ */
  }
  
  .sync-button-header {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    background: #e91e63;
    color: white;
    border: none;
    border-radius: 20px;
    padding: 5px 15px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    box-shadow: 0 2px 5px rgba(233, 30, 99, 0.3);
    transition: all 0.3s;
  }
  
  .sync-button-header:hover {
    background: #d81b60;
    transform: translateY(-50%) scale(1.05);
  }
  
  /* ÎœÎ•Î“Î‘Î›ÎŸ ÎšÎŸÎ¥ÎœÎ Î™ Î£Î¤Î—Î ÎšÎŸÎ¡Î¥Î¦Î— */
  .big-sync-button {
    position: fixed;
    top: 20px;
    right: 20px;
    background: #e91e63;
    color: white;
    border: none;
    border-radius: 25px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    z-index: 1000;
    transition: all 0.3s;
  }
  
  .big-sync-button:hover {
    background: #d81b60;
    transform: scale(1.05);
    box-shadow: 0 6px 15px rgba(0,0,0,0.3);
  }
  
  /* Î£Î¤Î‘Î¤ÎŸÎ¥Î£ Î£Î¥Î“Î§Î¡ÎŸÎÎ™Î£ÎœÎŸÎ¥ */
  .sync-status-dot {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-left: 10px;
    vertical-align: middle;
  }
  
  .sync-online { background: #4caf50; animation: pulse 2s infinite; }
  .sync-offline { background: #f44336; }
  .sync-connecting { background: #ff9800; animation: pulse 2s infinite; }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  /* Modal */
  .sync-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    padding: 20px;
  }
  
  .sync-modal-content {
    background: white;
    border-radius: 15px;
    padding: 30px;
    max-width: 400px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }
  
  .sync-modal h2 {
    color: #e91e63;
    margin-top: 0;
    text-align: center;
  }
  
  .sync-modal-section {
    margin: 20px 0;
    padding: 15px;
    background: #f9f9f9;
    border-radius: 10px;
  }

  input, select, button {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 15px;
  }

  button {
    cursor: pointer;
  }

  button.add { background: #e91e63; color: white; border: none; }
  button.del { background: #f44336; color: white; border: none; }
  button.cat { background: #ff80ab; color: white; border: none; }
  button.recurring { background: #4caf50; color: white; border: none; margin-top: 10px; }
  button.edit { background: #2196f3; color: white; border: none; padding: 4px 8px; font-size: 12px; }
  button.bank { background: #9c27b0; color: white; border: none; }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }

  th, td {
    padding: 8px;
    border-bottom: 1px solid #eee;
    text-align: left;
  }

  th {
    background: #ffe4ec;
  }

  .summary {
    margin-top: 20px;
    padding: 15px;
    background: #fff0f7;
    border-radius: 8px;
  }

  .summary strong {
    color: #e91e63;
  }

  .summary-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-top: 15px;
  }

  .summary-box {
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  .final-summary {
    margin-top: 20px;
    padding: 20px;
    background: linear-gradient(to right, #e8f5e9, #f1f8e9);
    border-radius: 8px;
    border: 2px solid #4caf50;
  }

  .final-numbers {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-top: 15px;
  }

  .final-number {
    text-align: center;
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .final-number h4 {
    margin: 0 0 10px 0;
    color: #333;
  }

  .final-number-value {
    font-size: 24px;
    font-weight: bold;
    margin: 10px 0;
  }

  .catlist {
    margin-top: 10px;
    font-size: 14px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
  }

  .category-item {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
    border-left: 4px solid #e91e63;
  }

  .category-item.over {
    border-left-color: #f44336;
  }

  .category-item.under {
    border-left-color: #4caf50;
  }

  .footer {
    text-align: center;
    margin-top: 20px;
    color: #888;
    font-size: 13px;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 8px;
  }

  .categories-manager {
    margin: 20px 0;
    padding: 15px;
    background: #f9f9f9;
    border-radius: 8px;
  }

  .categories-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin: 10px 0;
  }

  .category-tag {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 5px 10px;
    background: #e91e63;
    color: white;
    border-radius: 20px;
    font-size: 14px;
  }

  .category-tag button {
    background: transparent;
    border: none;
    color: white;
    cursor: pointer;
    padding: 0;
    font-size: 12px;
  }

  .bank-section {
    margin: 20px 0;
    padding: 15px;
    background: #f0f8ff;
    border-radius: 8px;
  }

  .bank-accounts {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }

  .bank-account {
    padding: 15px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  }

  /* ÎœÎ•Î›Î— Î£Î¥ÎÎ”Î•Î”Î•ÎœÎ•ÎÎ‘ */
  .connected-users {
    margin: 15px 0;
    padding: 10px;
    background: #e8f5e9;
    border-radius: 8px;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
  }
  
  .user-badge {
    background: #4caf50;
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  
  .user-badge.you {
    background: #e91e63;
  }

  @media (max-width: 768px) {
    .container {
      margin: 80px 10px 20px;
      padding: 15px 20px;
    }
    
    h1 {
      font-size: 1.5em;
    }
    
    .big-sync-button {
      top: 10px;
      right: 10px;
      padding: 8px 15px;
      font-size: 14px;
    }
    
    .sync-button-header {
      position: relative;
      margin-top: 10px;
      right: auto;
      top: auto;
      transform: none;
      display: block;
      width: fit-content;
      margin-left: auto;
      margin-right: auto;
    }
    
    input, select, button {
      margin-bottom: 8px;
      width: 100%;
    }
    
    table {
      font-size: 0.9em;
    }
    
    .catlist {
      grid-template-columns: 1fr;
    }
    
    .summary-grid {
      grid-template-columns: 1fr;
    }
    
    .bank-accounts {
      grid-template-columns: 1fr;
    }
    
    .final-numbers {
      grid-template-columns: 1fr;
    }
    
    .final-summary {
      padding: 15px;
    }
  }
</style>

<!-- Î’Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎµÏ‚ -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
</head>
<body>

<div class="stars" id="stars"></div>

<!-- ÎœÎ•Î“Î‘Î›ÎŸ ÎšÎŸÎ¥ÎœÎ Î™ Î£Î¥ÎÎ”Î•Î£Î—Î£ (Ï€Î¬Î½Ï‰ Î´ÎµÎ¾Î¹Î¬) -->
<button class="big-sync-button" onclick="showSyncModal()" id="mainSyncButton">
  ğŸ”— Î£Î¥Î“Î§Î¡ÎŸÎÎ™Î£ÎœÎŸÎ£
  <span class="sync-status-dot" id="mainSyncDot"></span>
</button>

<div class="container">
  <!-- Î¤Î™Î¤Î›ÎŸÎ£ ÎœÎ• ÎšÎŸÎ¥ÎœÎ Î™ -->
  <h1>
    <div class="sync-header">
      ğŸŒ¸ BudgetBuddy â€” ÎˆÎ¾Î¿Î´Î± Î£Ï€Î¹Ï„Î¹Î¿Ï ğŸŒ¸
      <button class="sync-button-header" onclick="showSyncModal()">
        <span id="syncButtonText">Î£Ï…Î½Î´Î­ÏƒÎ¿Ï…</span>
        <span class="sync-status-dot" id="headerSyncDot"></span>
      </button>
    </div>
  </h1>
  
  <!-- ÎœÎ•Î›Î— Î ÎŸÎ¥ Î•Î™ÎÎ‘Î™ Î£Î¥ÎÎ”Î•Î”Î•ÎœÎ•ÎÎ‘ -->
  <div class="connected-users" id="connectedUsers" style="display: none;">
    <strong>Î£Ï…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Î¹:</strong>
    <div id="usersList"></div>
  </div>

  <!-- Î¥Î ÎŸÎ›ÎŸÎ™Î Î— Î•Î¦Î‘Î¡ÎœÎŸÎ“Î— (Î‘ÎšÎ¡Î™Î’Î©Î£ Î™Î”Î™Î‘) -->
  <div>
    <label>ÎœÎ·Î½Î¹Î±Î¯Î¿ ÎµÎ¹ÏƒÏŒÎ´Î·Î¼Î± (â‚¬):</label>
    <input type="number" id="income" value="2000">
    &nbsp;&nbsp;
    <label>ÎœÎ®Î½Î±Ï‚:</label>
    <input type="month" id="month" value="">
  </div>

  <h3>â• ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· ÎµÎ¾ÏŒÎ´Î¿Ï…</h3>
  <div>
    <label>Î Î¿ÏƒÏŒ (â‚¬):</label>
    <input type="number" id="amount" step="0.01" style="width:100px;" placeholder="0.00">
    <label>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±:</label>
    <select id="category"></select>
    <label>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±:</label>
    <input type="date" id="date" value="">
    <br><br>
    <label>Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·:</label>
    <input type="text" id="note" placeholder="Ï€.Ï‡. ÏˆÏÎ½Î¹Î± ÏƒÎ¿ÏÏ€ÎµÏ Î¼Î¬ÏÎºÎµÏ„" style="width:250px;">
    <button class="add" onclick="addExpense()">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ·</button>
  </div>

  <h3>ğŸ’° Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï„ÏÎ±Ï€ÎµÎ¶Î¹ÎºÏÎ½ Ï…Ï€Î¿Î»Î¿Î¯Ï€Ï‰Î½</h3>
  <div class="bank-section">
    <div class="bank-accounts">
      <div class="bank-account">
        <h4>Î‘Î»Ï†Î± Î¤ÏÎ¬Ï€ÎµÎ¶Î±</h4>
        <input type="number" id="alphaBank" step="0.01" placeholder="0.00" style="width:100%;">
      </div>
      <div class="bank-account">
        <h4>Î•Î¸Î½Î¹ÎºÎ® Î¤ÏÎ¬Ï€ÎµÎ¶Î±</h4>
        <input type="number" id="nationalBank" step="0.01" placeholder="0.00" style="width:100%;">
      </div>
      <div class="bank-account">
        <h4>ÎœÎµÏ„ÏÎ·Ï„Î¬</h4>
        <input type="number" id="cash" step="0.01" placeholder="0.00" style="width:100%;">
      </div>
      <div class="bank-account">
        <h4>Î˜Î± Ï€Î¬ÏÏ‰ Î±ÎºÏŒÎ¼Î±</h4>
        <input type="number" id="expectedIncome" step="0.01" placeholder="0.00" style="width:100%;">
      </div>
    </div>
    <button class="bank" onclick="saveBankBalances()" style="margin-top: 15px;">ğŸ’¾ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î¥Ï€Î¿Î»Î¿Î¯Ï€Ï‰Î½</button>
  </div>

  <h3>âš™ï¸ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹ÏÎ½</h3>
  <div class="categories-manager">
    <div>
      <input type="text" id="newCategoryName" placeholder="ÎŒÎ½Î¿Î¼Î± Î½Î­Î±Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚" style="width:200px;">
      <button class="cat" onclick="addNewCategory()">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚</button>
    </div>
    
    <div class="categories-list" id="categoriesList"></div>
    
    <p><small>Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·: Î— Î´Î¹Î±Î³ÏÎ±Ï†Î® ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚ Î¸Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÎ¹ ÎºÎ±Î¹ Ï„Î± ÏƒÏ…Î½Î±Ï†Î® Î­Î¾Î¿Î´Î±!</small></p>
  </div>

  <h3>ğŸ’° Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î¼Î·Î½Î¹Î±Î¯Ï‰Î½ Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏÎ½</h3>
  <div id="recurringSetup" style="padding: 15px; background: #f9f9f9; border-radius: 8px; margin-bottom: 20px;">
    <p><strong>ÎŸÏÎ¯ÏƒÏ„Îµ Ï„Î¿Î½ Î¼Î·Î½Î¹Î±Î¯Î¿ Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒ Î³Î¹Î± ÎºÎ¬Î¸Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±:</strong></p>
    <div id="recurringInputs"></div>
    <button class="recurring" onclick="saveRecurringAmounts()">ğŸ’¾ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏÎ½</button>
    <button class="recurring" onclick="generateRecurringExpenses()">ğŸ”„ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î•Ï€Î±Î½Î±Î»Î±Î¼Î²Î±Î½ÏŒÎ¼ÎµÎ½Ï‰Î½ Î•Î¾ÏŒÎ´Ï‰Î½</button>
  </div>

  <h3>ğŸ“‹ Î Î¯Î½Î±ÎºÎ±Ï‚ ÎµÎ¾ÏŒÎ´Ï‰Î½</h3>
  <table id="expensesTable">
    <thead>
      <tr>
        <th>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</th>
        <th>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</th>
        <th>Î£Î·Î¼ÎµÎ¯Ï‰ÏƒÎ·</th>
        <th>Î Î¿ÏƒÏŒ (â‚¬)</th>
        <th>Î”Î¹Î±Î³ÏÎ±Ï†Î®</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>ğŸ“Š Î£ÏÎ½Î¿ÏˆÎ· Î±Î½Î¬ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</h3>
  <div class="catlist" id="catList"></div>

  <h3>ğŸ’° Î¤Î•Î›Î™ÎšÎ— Î£Î¥ÎÎŸÎ¨Î—</h3>
  <div class="final-summary">
    <h3 style="text-align: center; margin-top: 0; color: #2e7d32;">ğŸ“Š Î¤Î•Î›Î™ÎšÎ— Î•Î™ÎšÎŸÎÎ‘ Î§Î¡Î—ÎœÎ‘Î¤Î©Î</h3>
    
    <div class="final-numbers">
      <div class="final-number">
        <h4>Î•Î§ÎŸÎ¥Î ÎÎŸÎ”Î•Î¥Î¤Î•Î™</h4>
        <div class="final-number-value" id="totalSpent">0 â‚¬</div>
        <div style="color: #666; font-size: 14px;">Î£ÏÎ½Î¿Î»Î¿ Ï€Î»Î·ÏÏ‰Î¼Î­Î½Ï‰Î½ ÎµÎ¾ÏŒÎ´Ï‰Î½</div>
      </div>
      
      <div class="final-number">
        <h4>Î¥Î ÎŸÎ›ÎŸÎ™Î ÎŸ Î•ÎÎŸÎ”Î©Î</h4>
        <div class="final-number-value" id="remainingExpenses">0 â‚¬</div>
        <div style="color: #666; font-size: 14px;">Î‘Ï€Î¿Î¼Î­Î½ÎµÎ¹ Î½Î± Ï€Î»Î·ÏÏ‰Î¸Î¿ÏÎ½</div>
      </div>
      
      <div class="final-number">
        <h4>Î£Î¥ÎÎŸÎ›ÎŸ Î•Î£ÎŸÎ”Î©Î</h4>
        <div class="final-number-value" id="totalIncome">0 â‚¬</div>
        <div style="color: #666; font-size: 14px;">ÎŒÎ»Î± Ï„Î± Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î± Ï‡ÏÎ®Î¼Î±Ï„Î±</div>
      </div>
    </div>
    
    <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 8px; text-align: center;">
      <h4 style="margin: 0 0 10px 0; color: #333;">Î¤Î•Î›Î™ÎšÎŸ Î¥Î ÎŸÎ›ÎŸÎ™Î ÎŸ</h4>
      <div style="font-size: 28px; font-weight: bold; color: #e91e63;" id="finalBalance">0 â‚¬</div>
      <div style="color: #666; font-size: 14px; margin-top: 5px;">
        (Î£ÏÎ½Î¿Î»Î¿ Î•ÏƒÏŒÎ´Ï‰Î½ - ÎˆÏ‡Î¿Ï…Î½ ÎÎ¿Î´ÎµÏ…Ï„ÎµÎ¯)
      </div>
    </div>
  </div>

  <div class="footer" id="footerText">
    Î”ÎµÎ´Î¿Î¼Î­Î½Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÎ¿Î½Ï„Î±Î¹ Ï„Î¿Ï€Î¹ÎºÎ¬ (localStorage).
    <div id="syncInfo" style="margin-top: 5px;"></div>
  </div>
</div>

<!-- MODAL Î£Î¥Î“Î§Î¡ÎŸÎÎ™Î£ÎœÎŸÎ¥ -->
<div class="sync-modal" id="syncModal">
  <div class="sync-modal-content">
    <h2>ğŸ”— Î£Î¥Î“Î§Î¡ÎŸÎÎ™Î£ÎœÎŸÎ£ Î Î¡ÎŸÎ¥Î ÎŸÎ›ÎŸÎ“Î™Î£ÎœÎŸÎ¥</h2>
    
    <div id="syncModalContent">
      <!-- Î•Î´Ï Î¸Î± Ï†Î¿ÏÏ„ÏÎ½ÎµÎ¹ Î´Ï…Î½Î±Î¼Î¹ÎºÎ¬ Ï„Î¿ Ï€ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ -->
    </div>
    
    <div style="text-align: center; margin-top: 20px;">
      <button onclick="closeSyncModal()" style="padding: 8px 20px; background: #f0f0f0; border: none; border-radius: 5px; cursor: pointer;">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</button>
    </div>
  </div>
</div>

<script>
// ==================== ÎŸÎ›Î•Î£ ÎŸÎ™ Î Î‘Î›Î™Î•Î£ ÎœÎ•Î¤Î‘Î’Î›Î—Î¤Î•Î£ ====================
let categories = JSON.parse(localStorage.getItem('cats') || '[]');
let expenses = JSON.parse(localStorage.getItem('expenses') || '[]');
let recurringAmounts = JSON.parse(localStorage.getItem('recurringAmounts') || '{}');
let income = parseFloat(localStorage.getItem('income') || '2000');

let bankBalances = JSON.parse(localStorage.getItem('bankBalances') || JSON.stringify({
  alphaBank: 0,
  nationalBank: 0,
  cash: 0,
  expectedIncome: 0
}));

// ==================== Î£Î¥Î“Î§Î¡ÎŸÎÎ™Î£ÎœÎŸÎ£ ====================
let syncData = JSON.parse(localStorage.getItem('budgetbuddy_sync') || '{}');
let currentUser = syncData.userName || "ÎŸÎ¹ÎºÎ¿Î³Î­Î½ÎµÎ¹Î±";
let currentBudget = syncData.budgetCode || null;
let firebaseRef = null;

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBaItM0-eOAwU6snAxfMU_bcp9xW0UfYzQ",
  authDomain: "travelcosts-48d64.firebaseapp.com",
  databaseURL: "https://travelcosts-48d64-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "travelcosts-48d64",
  storageBucket: "travelcosts-48d64.firebasestorage.app",
  messagingSenderId: "792639383940",
  appId: "1:792639383940:web:ed991cc8426603015bd5d1"
};

if (firebase.apps.length === 0) {
  firebase.initializeApp(firebaseConfig);
}

// ==================== Î’ÎŸÎ—Î˜Î—Î¤Î™ÎšÎ•Î£ Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î•Î™Î£ ====================
function showQuickMessage(message, type = 'info') {
  const msg = document.createElement('div');
  msg.style.cssText = `
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: ${type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : '#333'};
    color: white;
    padding: 12px 24px;
    border-radius: 25px;
    z-index: 10000;
    font-size: 14px;
    animation: fadeInOut 3s ease-in-out;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    gap: 10px;
  `;
  msg.innerHTML = `
    ${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}
    <span>${message}</span>
  `;
  
  document.body.appendChild(msg);
  
  setTimeout(() => {
    msg.style.animation = 'fadeOut 0.5s ease-in-out';
    setTimeout(() => msg.remove(), 500);
  }, 3000);
  
  if (!document.getElementById('msg-styles')) {
    const style = document.createElement('style');
    style.id = 'msg-styles';
    style.textContent = `
      @keyframes fadeInOut {
        0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        10% { opacity: 1; transform: translateX(-50%) translateY(0); }
        90% { opacity: 1; transform: translateX(-50%) translateY(0); }
        100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
      }
      @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  }
}

function updateSyncUI(status, data = null) {
  const mainDot = document.getElementById('mainSyncDot');
  const headerDot = document.getElementById('headerSyncDot');
  const buttonText = document.getElementById('syncButtonText');
  const syncInfo = document.getElementById('syncInfo');
  const connectedUsers = document.getElementById('connectedUsers');
  const usersList = document.getElementById('usersList');
  
  if (status === 'online' && data) {
    mainDot.className = 'sync-status-dot sync-online';
    headerDot.className = 'sync-status-dot sync-online';
    buttonText.textContent = `Î£Ï…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿ (${data.members?.length || 1})`;
    
    if (data.members && data.members.length > 0) {
      connectedUsers.style.display = 'flex';
      usersList.innerHTML = data.members.map(member => 
        `<div class="user-badge ${member === currentUser ? 'you' : ''}">${member}${member === currentUser ? ' (Î•ÏƒÏ)' : ''}</div>`
      ).join('');
    }
    
    syncInfo.innerHTML = `<strong>Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼Î­Î½Î¿:</strong> ${data.name || currentBudget} | ÎšÏ‰Î´Î¹ÎºÏŒÏ‚: <strong>${currentBudget}</strong>`;
    
  } else if (status === 'connecting') {
    mainDot.className = 'sync-status-dot sync-connecting';
    headerDot.className = 'sync-status-dot sync-connecting';
    buttonText.textContent = 'Î£Ï…Î½Î´Î­ÎµÏ„Î±Î¹...';
    syncInfo.innerHTML = 'Î£ÏÎ½Î´ÎµÏƒÎ· ÏƒÎµ cloud...';
    connectedUsers.style.display = 'none';
    
  } else {
    mainDot.className = 'sync-status-dot sync-offline';
    headerDot.className = 'sync-status-dot sync-offline';
    buttonText.textContent = 'Î£Ï…Î½Î´Î­ÏƒÎ¿Ï…';
    syncInfo.innerHTML = 'Î§Ï‰ÏÎ¯Ï‚ ÏƒÏ…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒ - Î´ÎµÎ´Î¿Î¼Î­Î½Î± Ï„Î¿Ï€Î¹ÎºÎ¬';
    connectedUsers.style.display = 'none';
  }
}

// ==================== Î£Î¥Î“Î§Î¡ÎŸÎÎ™Î£ÎœÎŸÎ£ ====================
function initSync() {
  if (!currentBudget) {
    updateSyncUI('offline');
    return;
  }
  
  const database = firebase.database();
  firebaseRef = database.ref(`budgets/${currentBudget}`);
  
  updateSyncUI('connecting');
  
  firebaseRef.on('value', (snapshot) => {
    const data = snapshot.val();
    if (data) {
      // Î’ÏÎ®ÎºÎ±Î¼Îµ Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒ
      syncData.budgetName = data.name;
      syncData.creator = data.creator;
      syncData.members = data.members || [currentUser];
      
      // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Î¿Ï€Î¹ÎºÏÎ½ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
      categories = data.categories || [];
      expenses = data.expenses || [];
      recurringAmounts = data.recurringAmounts || {};
      income = data.income || 2000;
      bankBalances = data.bankBalances || bankBalances;
      
      saveAllData();
      initFields();
      render();
      
      updateSyncUI('online', data);
      showQuickMessage('ğŸ“¡ Î£Ï…Î½Î´ÎµÎ¸Î®ÎºÎ±Ï„Îµ ÏƒÏ„Î¿Î½ Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒ', 'success');
      
    } else {
      // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î½Î­Î¿Ï…
      createNewBudgetInFirebase();
    }
  }, (error) => {
    console.error("Firebase error:", error);
    updateSyncUI('offline');
  });
}

function createNewBudgetInFirebase() {
  if (!currentBudget) return;
  
  const budgetName = syncData.budgetName || `Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ${currentBudget}`;
  
  const newBudget = {
    code: currentBudget,
    name: budgetName,
    creator: currentUser,
    created: Date.now(),
    members: [currentUser],
    categories: categories.length > 0 ? categories : ['Î£Î¿ÏÏ€ÎµÏ ÎœÎ¬ÏÎºÎµÏ„', 'ÎÎ¿Î¯ÎºÎ¹', 'Î—Î»ÎµÎºÏ„ÏÎ¹ÎºÏŒ', 'ÎÎµÏÏŒ', 'Î¤Î·Î»Î­Ï†Ï‰Î½Î±', 'ÎšÎ±ÏÏƒÎ¹Î¼Î±', 'Î¨Ï…Ï‡Î±Î³Ï‰Î³Î¯Î±'],
    expenses: expenses,
    recurringAmounts: recurringAmounts,
    income: income,
    bankBalances: bankBalances,
    lastUpdated: Date.now(),
    lastUpdatedBy: currentUser
  };
  
  firebaseRef.set(newBudget)
    .then(() => {
      updateSyncUI('online', newBudget);
      showQuickMessage('âœ… Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎµ Î½Î­Î¿Ï‚ Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚', 'success');
    })
    .catch(error => {
      console.error("Firebase create error:", error);
      updateSyncUI('offline');
      showQuickMessage('âŒ Î£Ï†Î¬Î»Î¼Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±Ï‚', 'error');
    });
}

function syncToFirebase() {
  if (!currentBudget || !firebaseRef) return;
  
  const budgetData = {
    code: currentBudget,
    name: syncData.budgetName || `Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚ ${currentBudget}`,
    creator: syncData.creator || currentUser,
    members: syncData.members || [currentUser],
    categories: categories,
    expenses: expenses,
    recurringAmounts: recurringAmounts,
    income: income,
    bankBalances: bankBalances,
    lastUpdated: Date.now(),
    lastUpdatedBy: currentUser
  };
  
  firebaseRef.set(budgetData)
    .then(() => {
      console.log("âœ… Î£Ï…Î³Ï‡ÏÎ¿Î½Î¯ÏƒÏ„Î·ÎºÎµ");
    })
    .catch(error => {
      console.error("Firebase sync error:", error);
    });
}

// ==================== MODAL Î£Î¥Î“Î§Î¡ÎŸÎÎ™Î£ÎœÎŸÎ¥ ====================
function showSyncModal() {
  const modal = document.getElementById('syncModal');
  const content = document.getElementById('syncModalContent');
  
  if (currentBudget) {
    // Î•Î¯Î¼Î±ÏƒÏ„Îµ Î®Î´Î· ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Î¹
    content.innerHTML = `
      <div class="sync-modal-section">
        <h3>âœ… Î•Î¯ÏƒÏ„Îµ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½Î¿Î¹!</h3>
        <p><strong>Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚:</strong> ${syncData.budgetName || currentBudget}</p>
        <p><strong>ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚:</strong></p>
        <div style="text-align: center; margin: 15px 0;">
          <div style="font-size: 32px; font-weight: bold; letter-spacing: 3px; color: #e91e63; background: #f9f9f9; padding: 15px; border-radius: 10px;">
            ${currentBudget}
          </div>
        </div>
        <p><small>Î”ÏÏƒÏ„Îµ Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ ÏƒÏ„Î¿Î½ ÏƒÏÎ¶Ï…Î³Î¿/ÏƒÏÎ¶Ï…Î³Î¿ Î³Î¹Î± Î½Î± ÏƒÏ…Î½Î´ÎµÎ¸ÎµÎ¯</small></p>
      </div>
      
      <div class="sync-modal-section">
        <h3>ğŸ“± ÎšÎ¿Î¹Î½Î® Ï‡ÏÎ®ÏƒÎ·</h3>
        <button onclick="showQRCode()" style="width: 100%; padding: 12px; background: #4caf50; color: white; border: none; border-radius: 8px; margin-bottom: 10px; cursor: pointer;">
          ğŸ´ Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· QR Code
        </button>
        <button onclick="copySyncCode()" style="width: 100%; padding: 12px; background: #2196f3; color: white; border: none; border-radius: 8px; margin-bottom: 10px; cursor: pointer;">
          ğŸ“‹ Î‘Î½Ï„Î¹Î³ÏÎ±Ï†Î® ÎšÏ‰Î´Î¹ÎºÎ¿Ï
        </button>
        <button onclick="disconnectSync()" style="width: 100%; padding: 12px; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer;">
          ğŸ”Œ Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·
        </button>
      </div>
      
      <div class="sync-modal-section">
        <h3>ğŸ‘¥ ÎœÎ­Î»Î·</h3>
        <div id="modalUsersList">
          ${syncData.members?.map(m => `<div style="padding: 5px; background: ${m === currentUser ? '#ffe6f1' : '#f0f0f0'}; margin: 5px 0; border-radius: 5px;">${m}${m === currentUser ? ' (Î•ÏƒÏ)' : ''}</div>`).join('') || currentUser}
        </div>
      </div>
    `;
  } else {
    // Î§Ï‰ÏÎ¯Ï‚ ÏƒÏ…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒ
    content.innerHTML = `
      <div class="sync-modal-section">
        <h3>ğŸ”— Î£Ï…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï</h3>
        <p>Î£Ï…Î½Î´Î­ÏƒÏ„Îµ 2 Î® Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎ± ÎºÎ¹Î½Î·Ï„Î¬ Î³Î¹Î± Î½Î± Î­Ï‡ÎµÏ„Îµ Ï„Î± Î¯Î´Î¹Î± Î´ÎµÎ´Î¿Î¼Î­Î½Î± ÏƒÎµ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒ Ï‡ÏÏŒÎ½Î¿!</p>
      </div>
      
      <div class="sync-modal-section">
        <h3>ğŸš€ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î½Î­Î¿Ï… Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï</h3>
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">Î¤Î¿ ÎŒÎ½Î¿Î¼Î¬ Î£Î±Ï‚:</label>
          <input type="text" id="newUserName" value="${currentUser}" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
        </div>
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÎŒÎ½Î¿Î¼Î± Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï:</label>
          <input type="text" id="newBudgetName" placeholder="Ï€.Ï‡. ÎŸÎ¹ÎºÎ¿Î³Î­Î½ÎµÎ¹Î± Î™Î±Î½Î¿Ï…Î¬ÏÎ¹Î¿Ï‚" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
        </div>
        <button onclick="createNewSync()" style="width: 100%; padding: 12px; background: #e91e63; color: white; border: none; border-radius: 8px; cursor: pointer;">
          ğŸš€ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎÎ­Î¿Ï… Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï
        </button>
      </div>
      
      <div class="sync-modal-section">
        <h3>ğŸ”— Î£ÏÎ½Î´ÎµÏƒÎ· ÏƒÎµ Ï…Ï€Î¬ÏÏ‡Î¿Î½ Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒ</h3>
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">Î¤Î¿ ÎŒÎ½Î¿Î¼Î¬ Î£Î±Ï‚:</label>
          <input type="text" id="joinUserName" value="${currentUser}" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc;">
        </div>
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÎšÏ‰Î´Î¹ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï:</label>
          <input type="text" id="joinBudgetCode" placeholder="6 ÏˆÎ·Ï†Î¯Î±" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; text-align: center; letter-spacing: 3px; font-size: 18px;">
        </div>
        <button onclick="joinExistingSync()" style="width: 100%; padding: 12px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer;">
          ğŸ”— Î£ÏÎ½Î´ÎµÏƒÎ· ÏƒÎµ Î¥Ï€Î¬ÏÏ‡Î¿Î½ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒ
        </button>
      </div>
    `;
  }
  
  modal.style.display = 'flex';
}

function closeSyncModal() {
  document.getElementById('syncModal').style.display = 'none';
}

function createNewSync() {
  const userName = document.getElementById('newUserName').value.trim() || "ÎŸÎ¹ÎºÎ¿Î³Î­Î½ÎµÎ¹Î±";
  const budgetName = document.getElementById('newBudgetName').value.trim() || "ÎŸÎ¹ÎºÎ¿Î³ÎµÎ½ÎµÎ¹Î±ÎºÏŒÏ‚ Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚";
  
  if (!budgetName) {
    showQuickMessage('âš ï¸ Î£Ï…Î¼Ï€Î»Î·ÏÏÏƒÏ„Îµ ÏŒÎ½Î¿Î¼Î± Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Ï', 'error');
    return;
  }
  
  currentUser = userName;
  currentBudget = generateSyncCode();
  
  syncData = {
    userName: userName,
    budgetCode: currentBudget,
    budgetName: budgetName,
    creator: userName,
    members: [userName]
  };
  
  localStorage.setItem('budgetbuddy_sync', JSON.stringify(syncData));
  
  closeSyncModal();
  initSync();
}

function joinExistingSync() {
  const userName = document.getElementById('joinUserName').value.trim() || "ÎŸÎ¹ÎºÎ¿Î³Î­Î½ÎµÎ¹Î±";
  const joinCode = document.getElementById('joinBudgetCode').value.trim().toUpperCase();
  
  if (!joinCode || joinCode.length !== 6) {
    showQuickMessage('âš ï¸ Î•Î¹ÏƒÎ¬Î³ÎµÏ„Îµ 6-ÏˆÎ®Ï†Î¹Î¿ ÎºÏ‰Î´Î¹ÎºÏŒ', 'error');
    return;
  }
  
  currentUser = userName;
  currentBudget = joinCode;
  
  syncData = {
    userName: userName,
    budgetCode: joinCode,
    members: [userName]
  };
  
  localStorage.setItem('budgetbuddy_sync', JSON.stringify(syncData));
  
  closeSyncModal();
  initSync();
}

function showQRCode() {
  if (!currentBudget) return;
  
  const qrData = {
    app: "BudgetBuddy",
    code: currentBudget,
    name: syncData.budgetName || "Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚",
    type: "join"
  };
  
  const qrText = JSON.stringify(qrData);
  const qrContainer = document.createElement('div');
  qrContainer.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    padding: 20px;
  `;
  
  QRCode.toCanvas(qrText, { width: 250 }, function(error, canvas) {
    if (error) {
      console.error('QR error:', error);
      return;
    }
    
    qrContainer.innerHTML = `
      <div style="background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 300px;">
        <h2 style="color: #e91e63; margin-top: 0;">ğŸ“± Î£ÏÎ½Î´ÎµÏƒÎ·</h2>
        <p>Î£ÎºÎ±Î½Î¬ÏÎµÏ„Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ QR code Î¼Îµ Ï„Î¿ Î¬Î»Î»Î¿ ÎºÎ¹Î½Î·Ï„ÏŒ:</p>
        <div style="margin: 20px 0; padding: 15px; background: white; border-radius: 10px;">
          ${canvas.outerHTML}
        </div>
        <h3 style="font-family: monospace; letter-spacing: 3px; color: #333; margin: 15px 0;">${currentBudget}</h3>
        <p style="color: #666;">ÎšÏ‰Î´Î¹ÎºÏŒÏ‚: <strong>${currentBudget}</strong></p>
        <button onclick="this.parentElement.parentElement.remove()" style="padding: 10px 25px; background: #e91e63; color: white; border: none; border-radius: 8px; margin-top: 15px; cursor: pointer;">
          ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿
        </button>
      </div>
    `;
    
    document.body.appendChild(qrContainer);
  });
}

function copySyncCode() {
  if (!currentBudget) return;
  
  navigator.clipboard.writeText(currentBudget).then(() => {
    showQuickMessage('ğŸ“‹ Î‘Î½Ï„Î¹Î³ÏÎ¬Ï†Î·ÎºÎµ Î¿ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚!', 'success');
  }).catch(() => {
    const tempInput = document.createElement('input');
    tempInput.value = currentBudget;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand('copy');
    document.body.removeChild(tempInput);
    showQuickMessage('ğŸ“‹ Î‘Î½Ï„Î¹Î³ÏÎ¬Ï†Î·ÎºÎµ Î¿ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚!', 'success');
  });
}

function disconnectSync() {
  if (confirm('Î˜Î­Î»ÎµÏ„Îµ Î½Î± Î±Ï€Î¿ÏƒÏ…Î½Î´ÎµÎ¸ÎµÎ¯Ï„Îµ Î±Ï€ÏŒ Ï„Î¿Î½ ÏƒÏ…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒ;\nÎ¤Î± Ï„Î¿Ï€Î¹ÎºÎ¬ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î¸Î± Ï€Î±ÏÎ±Î¼ÎµÎ¯Î½Î¿Ï…Î½.')) {
    if (firebaseRef) {
      firebaseRef.off();
    }
    
    currentBudget = null;
    syncData = {};
    localStorage.setItem('budgetbuddy_sync', JSON.stringify({}));
    
    closeSyncModal();
    updateSyncUI('offline');
    showQuickMessage('ğŸ”Œ Î‘Ï€Î¿ÏƒÏ…Î½Î´ÎµÎ¸Î®ÎºÎ±Ï„Îµ Î±Ï€ÏŒ ÏƒÏ…Î³Ï‡ÏÎ¿Î½Î¹ÏƒÎ¼ÏŒ', 'success');
  }
}

function generateSyncCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 6; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

// ==================== ÎŸÎ™ Î Î‘Î›Î™Î•Î£ Î£Î¥ÎÎ‘Î¡Î¤Î—Î£Î•Î™Î£ ====================
function cleanupData() {
  categories = categories.filter(cat => cat && typeof cat === 'string' && cat.trim() !== '');
  
  const cleanRecurring = {};
  categories.forEach(cat => {
    if (recurringAmounts[cat] !== undefined) {
      const value = parseFloat(recurringAmounts[cat]);
      cleanRecurring[cat] = isNaN(value) ? 0 : value;
    }
  });
  recurringAmounts = cleanRecurring;
}

function saveAllData() {
  localStorage.setItem('cats', JSON.stringify(categories));
  localStorage.setItem('expenses', JSON.stringify(expenses));
  localStorage.setItem('recurringAmounts', JSON.stringify(recurringAmounts));
  localStorage.setItem('income', income);
  localStorage.setItem('bankBalances', JSON.stringify(bankBalances));
  
  if (currentBudget) {
    syncToFirebase();
  }
}

function initFields() {
  cleanupData();
  
  document.getElementById('income').value = income;
  
  const currentMonth = new Date().toISOString().slice(0,7);
  const monthInput = document.getElementById('month');
  if (!monthInput.value) {
    monthInput.value = currentMonth;
  }
  
  const today = new Date().toISOString().slice(0,10);
  document.getElementById('date').value = today;
  
  document.getElementById('alphaBank').value = bankBalances.alphaBank || 0;
  document.getElementById('nationalBank').value = bankBalances.nationalBank || 0;
  document.getElementById('cash').value = bankBalances.cash || 0;
  document.getElementById('expectedIncome').value = bankBalances.expectedIncome || 0;
  
  updateCategoriesList();
  updateRecurringInputs();
}

function saveBankBalances() {
  bankBalances = {
    alphaBank: parseFloat(document.getElementById('alphaBank').value) || 0,
    nationalBank: parseFloat(document.getElementById('nationalBank').value) || 0,
    cash: parseFloat(document.getElementById('cash').value) || 0,
    expectedIncome: parseFloat(document.getElementById('expectedIncome').value) || 0
  };
  
  saveAllData();
  showQuickMessage('ğŸ’° Î¤Î± Ï„ÏÎ±Ï€ÎµÎ¶Î¹ÎºÎ¬ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î± Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½!', 'success');
  render();
}

function updateCategoriesList() {
  const categoriesListDiv = document.getElementById('categoriesList');
  let html = '';
  
  categories.forEach((category, index) => {
    html += `
      <div class="category-tag">
        ${category}
        <button onclick="deleteCategory(${index})" title="Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚">Ã—</button>
      </div>
    `;
  });
  
  categoriesListDiv.innerHTML = html || '<p style="color:#777;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚. Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ ÎºÎ¬Ï€Î¿Î¹ÎµÏ‚!</p>';
}

function addNewCategory() {
  const newCategoryInput = document.getElementById('newCategoryName');
  const categoryName = newCategoryInput.value.trim();
  
  if (!categoryName) {
    showQuickMessage('âš ï¸ Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ ÏŒÎ½Î¿Î¼Î± ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚', 'error');
    return;
  }
  
  if (categories.includes(categoryName)) {
    showQuickMessage('âš ï¸ Î— ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î·!', 'error');
    return;
  }
  
  categories.push(categoryName);
  newCategoryInput.value = '';
  
  saveAllData();
  updateCategoriesList();
  updateRecurringInputs();
  showQuickMessage(`âœ… Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ Î· ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± "${categoryName}"`, 'success');
}

function deleteCategory(index) {
  const categoryName = categories[index];
  
  if (!confirm(`Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚ "${categoryName}";\nÎ˜Î± Î´Î¹Î±Î³ÏÎ±Ï†Î¿ÏÎ½ ÎºÎ±Î¹ ÏŒÎ»Î± Ï„Î± ÏƒÏ‡ÎµÏ„Î¹ÎºÎ¬ Î­Î¾Î¿Î´Î±!\nÎ£Î¯Î³Î¿Ï…ÏÎ±;`)) {
    return;
  }
  
  categories.splice(index, 1);
  expenses = expenses.filter(e => e.category !== categoryName);
  
  if (recurringAmounts[categoryName]) {
    delete recurringAmounts[categoryName];
  }
  
  saveAllData();
  updateCategoriesList();
  updateRecurringInputs();
  showQuickMessage(`ğŸ—‘ï¸ Î”Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ Î· ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± "${categoryName}"`, 'success');
}

function updateRecurringInputs() {
  const recurringInputsDiv = document.getElementById('recurringInputs');
  let html = '';
  
  if (categories.length === 0) {
    html = '<p style="color:#777; font-style:italic;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚. Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Ï€ÏÏÏ„Î± ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚.</p>';
  } else {
    categories.forEach((category, index) => {
      const amount = recurringAmounts[category] || 0;
      const uniqueId = `recurring_${index}_${category.replace(/\s+/g, '_')}`;
      
      html += `
        <div style="margin-bottom: 10px;">
          <label style="display: inline-block; width: 200px; vertical-align: middle;">${category}:</label>
          <input type="number" 
                 id="${uniqueId}" 
                 value="${amount}" 
                 step="0.01" 
                 style="width: 100px; vertical-align: middle;"
                 onchange="updateSingleRecurringAmount('${category}', this.value)">
          â‚¬
          <span style="margin-left: 10px; color: #666; font-size: 12px;">
            (Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Ï„Î¹Î¼Î®: ${amount} â‚¬)
          </span>
        </div>
      `;
    });
  }
  
  recurringInputsDiv.innerHTML = html;
}

function updateSingleRecurringAmount(category, value) {
  const numValue = parseFloat(value) || 0;
  recurringAmounts[category] = numValue;
  
  const inputElement = document.querySelector(`input[value="${value}"]`);
  if (inputElement) {
    const span = inputElement.nextElementSibling?.nextElementSibling;
    if (span) {
      span.textContent = ` (Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Ï„Î¹Î¼Î®: ${numValue} â‚¬)`;
    }
  }
  
  saveAllData();
}

function saveRecurringAmounts() {
  if (categories.length === 0) {
    showQuickMessage('âš ï¸ Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚. Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Ï€ÏÏÏ„Î± ÎºÎ¬Ï€Î¿Î¹ÎµÏ‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚', 'error');
    return;
  }
  
  categories.forEach(category => {
    const inputs = document.querySelectorAll(`input[id^="recurring_"]`);
    let foundValue = recurringAmounts[category] || 0;
    
    inputs.forEach(input => {
      if (input.id.includes(category.replace(/\s+/g, '_')) || 
          input.previousElementSibling?.textContent?.includes(category)) {
        const value = parseFloat(input.value) || 0;
        foundValue = value;
      }
    });
    
    recurringAmounts[category] = foundValue;
  });
  
  saveAllData();
  showQuickMessage('ğŸ’¾ ÎŸÎ¹ Î¼Î·Î½Î¹Î±Î¯Î¿Î¹ Ï€ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼Î¿Î¯ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½!', 'success');
  updateRecurringInputs();
  render();
}

function generateRecurringExpenses() {
  if (categories.length === 0) {
    showQuickMessage('âš ï¸ Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚. Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Ï€ÏÏÏ„Î± ÎºÎ¬Ï€Î¿Î¹ÎµÏ‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚', 'error');
    return;
  }
  
  const selectedMonth = document.getElementById('month').value;
  if (!selectedMonth) {
    showQuickMessage('âš ï¸ Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï€ÏÏÏ„Î± Î­Î½Î± Î¼Î®Î½Î±!', 'error');
    return;
  }
  
  const monthExpenses = expenses.filter(e => e.date.startsWith(selectedMonth));
  const hasRecurringForMonth = monthExpenses.some(e => e.isRecurring === true);
  
  if (hasRecurringForMonth) {
    if (!confirm('Î¥Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î®Î´Î· ÎµÏ€Î±Î½Î±Î»Î±Î¼Î²Î±Î½ÏŒÎ¼ÎµÎ½Î± Î­Î¾Î¿Î´Î± Î³Î¹Î± Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Î¼Î®Î½Î±. Î˜Î­Î»ÎµÏ„Îµ Î½Î± Ï„Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎµÏ„Îµ Î¾Î±Î½Î¬ (Î¸Î± Î´Î¹Î±Î³ÏÎ±Ï†Î¿ÏÎ½ Ï„Î± Ï€Î±Î»Î¹Î¬);')) {
      return;
    }
    
    expenses = expenses.filter(e => !(e.date.startsWith(selectedMonth) && e.isRecurring === true));
  }
  
  categories.forEach(category => {
    const amount = recurringAmounts[category] || 0;
    
    if (amount > 0) {
      const newExpense = {
        id: Date.now() + Math.random(),
        amount: amount,
        category: category,
        date: selectedMonth + '-01',
        note: 'ÎœÎ·Î½Î¹Î±Î¯Î¿ Î­Î¾Î¿Î´Î¿',
        isRecurring: true
      };
      
      expenses.push(newExpense);
    }
  });
  
  saveAllData();
  showQuickMessage(`ğŸ”„ Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎ±Î½ ÎµÏ€Î±Î½Î±Î»Î±Î¼Î²Î±Î½ÏŒÎ¼ÎµÎ½Î± Î­Î¾Î¿Î´Î± Î³Î¹Î± ${selectedMonth}`, 'success');
}

function addExpense() {
  if (categories.length === 0) {
    showQuickMessage('âš ï¸ Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚. Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Ï€ÏÏÏ„Î± ÎºÎ¬Ï€Î¿Î¹ÎµÏ‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚', 'error');
    return;
  }
  
  const amount = parseFloat(document.getElementById('amount').value);
  const category = document.getElementById('category').value;
  const date = document.getElementById('date').value;
  const note = document.getElementById('note').value.trim();
  
  if (!amount || amount <= 0) {
    showQuickMessage('âš ï¸ Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÎ¹ÏƒÎ¬Î³ÎµÏ„Îµ Î­Î½Î± Î­Î³ÎºÏ…ÏÎ¿ Ï€Î¿ÏƒÏŒ', 'error');
    document.getElementById('amount').focus();
    return;
  }
  
  if (!date) {
    showQuickMessage('âš ï¸ Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Î·Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±', 'error');
    document.getElementById('date').focus();
    return;
  }
  
  if (!category) {
    showQuickMessage('âš ï¸ Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±', 'error');
    document.getElementById('category').focus();
    return;
  }
  
  const newExpense = {
    id: Date.now() + Math.random(),
    amount: amount,
    category: category,
    date: date,
    note: note || '-',
    isRecurring: false
  };
  
  expenses.push(newExpense);
  
  document.getElementById('amount').value = '';
  document.getElementById('note').value = '';
  
  saveAllData();
  showQuickMessage(`âœ… Î ÏÎ¿ÏƒÏ„Î­Î¸Î·ÎºÎµ Î­Î¾Î¿Î´Î¿ ${category} - ${amount.toFixed(2)}â‚¬`, 'success');
}

function deleteExpense(id) {
  if (!confirm('Î˜Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ Î­Î¾Î¿Î´Î¿;')) return;
  
  expenses = expenses.filter(e => e.id !== id);
  saveAllData();
  showQuickMessage('ğŸ—‘ï¸ Î¤Î¿ Î­Î¾Î¿Î´Î¿ Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ', 'success');
}

function render() {
  const categorySelect = document.getElementById('category');
  if (categories.length > 0) {
    categorySelect.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
  } else {
    categorySelect.innerHTML = '<option value="">Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Ï€ÏÏÏ„Î± ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚</option>';
  }
  
  const selectedMonth = document.getElementById('month').value;
  const filteredExpenses = selectedMonth 
    ? expenses.filter(e => e.date.startsWith(selectedMonth))
    : expenses;
  
  const tbody = document.querySelector('#expensesTable tbody');
  
  if (filteredExpenses.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#777;padding:20px;">
      Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ·Î¼Î­Î½Î± Î­Î¾Î¿Î´Î± Î³Î¹Î± Î±Ï…Ï„ÏŒÎ½ Ï„Î¿Î½ Î¼Î®Î½Î±.</td></tr>`;
  } else {
    tbody.innerHTML = filteredExpenses.map(e => `
      <tr>
        <td>${e.date}</td>
        <td>${e.category} ${e.isRecurring ? 'ğŸ”„' : ''}</td>
        <td>${e.note}</td>
        <td>${e.amount.toFixed(2)}</td>
        <td><button class='del' onclick='deleteExpense(${e.id})'>âœ•</button></td>
      </tr>
    `).join('');
  }
  
  const categorySummary = {};
  let actualExpenses = 0;
  let plannedExpenses = 0;
  
  categories.forEach(category => {
    const categoryExpenses = filteredExpenses.filter(e => e.category === category);
    const categoryTotal = categoryExpenses.reduce((sum, expense) => sum + expense.amount, 0);
    const categoryBudget = recurringAmounts[category] || 0;
    
    categorySummary[category] = {
      spent: categoryTotal,
      budget: categoryBudget,
      remaining: categoryBudget - categoryTotal
    };
    
    actualExpenses += categoryTotal;
    plannedExpenses += categoryBudget;
  });
  
  const catListDiv = document.getElementById('catList');
  let catHtml = '';
  
  if (categories.length === 0) {
    catHtml = '<p style="color:#777; font-style:italic; grid-column: 1/-1;">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚. Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ ÎºÎ¬Ï€Î¿Î¹ÎµÏ‚ Î±Ï€ÏŒ Ï„Î¿ Ï„Î¼Î®Î¼Î± "Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· ÎºÎ±Ï„Î·Î³Î¿ÏÎ¹ÏÎ½".</p>';
  } else {
    categories.forEach(category => {
      const summary = categorySummary[category] || { spent: 0, budget: 0, remaining: 0 };
      const remaining = summary.remaining;
      const spentPercentage = summary.budget > 0 ? (summary.spent / summary.budget * 100).toFixed(1) : 0;
      
      let statusClass = '';
      if (remaining < 0) {
        statusClass = 'over';
      } else if (remaining > 0) {
        statusClass = 'under';
      }
      
      catHtml += `
        <div class="category-item ${statusClass}">
          <strong>${category}</strong><br>
          Î ÏÎ¿Ï‹Ï€Î¿Î»Î¿Î³Î¹ÏƒÎ¼ÏŒÏ‚: ${summary.budget.toFixed(2)} â‚¬<br>
          ÎÎ¿Î´ÎµÏÏ„Î·ÎºÎ±Î½: ${summary.spent.toFixed(2)} â‚¬<br>
          <strong>ÎœÎ­Î½Î¿Ï…Î½: ${remaining.toFixed(2)} â‚¬</strong><br>
          ${summary.budget > 0 ? `(${spentPercentage}%)` : ''}
        </div>
      `;
    });
  }
  
  catListDiv.innerHTML = catHtml;
  
  const totalSpent = actualExpenses;
  const remainingExpenses = plannedExpenses - actualExpenses;
  const currentMoney = (bankBalances.alphaBank || 0) + (bankBalances.nationalBank || 0) + (bankBalances.cash || 0);
  const futureMoney = bankBalances.expectedIncome || 0;
  const totalIncome = currentMoney + futureMoney;
  const finalBalance = totalIncome - totalSpent;
  
  document.getElementById('totalSpent').textContent = totalSpent.toFixed(2) + ' â‚¬';
  document.getElementById('remainingExpenses').textContent = remainingExpenses.toFixed(2) + ' â‚¬';
  document.getElementById('totalIncome').textContent = totalIncome.toFixed(2) + ' â‚¬';
  document.getElementById('finalBalance').textContent = finalBalance.toFixed(2) + ' â‚¬';
  
  const finalBalanceElement = document.getElementById('finalBalance');
  if (finalBalance < 0) {
    finalBalanceElement.style.color = '#f44336';
  } else if (finalBalance < totalIncome * 0.1) {
    finalBalanceElement.style.color = '#ff9800';
  } else {
    finalBalanceElement.style.color = '#4caf50';
  }
}

function save() {
  cleanupData();
  income = parseFloat(document.getElementById('income').value) || 0;
  saveAllData();
  render();
}

function createStars() {
  const starsContainer = document.getElementById('stars');
  const starColors = ['#fff', '#ffd1e8', '#ffb6c1', '#ffc0cb'];
  
  for (let i = 0; i < 40; i++) {
    const star = document.createElement('div');
    star.classList.add('star');
    star.textContent = 'â˜…';
    star.style.left = Math.random() * 100 + '%';
    star.style.top = Math.random() * 100 + 'px';
    star.style.animationDelay = (Math.random() * 5) + 's';
    star.style.color = starColors[Math.floor(Math.random() * starColors.length)];
    starsContainer.appendChild(star);
  }
}

// ==================== Î‘Î¡Î§Î™ÎšÎŸÎ ÎŸÎ™Î—Î£Î— ====================
document.getElementById('income').addEventListener('input', () => save());
document.getElementById('month').addEventListener('input', () => render());

window.onload = function() {
  createStars();
  
  const currentMonth = new Date().toISOString().slice(0,7);
  document.getElementById('month').value = currentMonth;
  
  const today = new Date().toISOString().slice(0,10);
  document.getElementById('date').value = today;
  
  initFields();
  render();
  initSync();
  
  setInterval(() => {
    if (currentBudget) {
      syncToFirebase();
    }
  }, 30000);
};
</script>
</body>
</html>
